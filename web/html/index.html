<!DOCTYPE html>
<html lang="en">
    <head>
       <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
       <meta charset="utf-8">
       <meta http-equiv="X-UA-Compatible" content="IE=edge">
       <meta name="viewport" content="width=device-width, initial-scale=1">
       <meta name="description" content="">
       <meta name="author" content="">

       <title>snaprate</title>
       <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
       <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
       <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
       <link href="{{static_url("css/jumbotron.css")}}" rel="stylesheet">
         <script src="https://unpkg.com/iv-viewer/dist/iv-viewer.js"></script>

         <link rel="stylesheet" href="https://unpkg.com/iv-viewer/dist/iv-viewer.css">
    </head>
    <body>

        {{rate_subjects}} <hr>

    <script>
    {{images}}
    visible_subject = {{visible_subject}};

    visible_image = 1;
    n_subjects = {{n_subjects}};

    $("img.subject" + visible_subject + "#image1").show();

    function showImage() {
              visible_class = 'subject' + visible_subject;
              imgObj = images[visible_subject - 1];
              viewer.load(imgObj.small, imgObj.big);
              $("span#subject_number").text(visible_subject);
              $("span#image_number").text(visible_image);
            }

    function validate(){
      ans = $('input').val();
      if (ans.indexOf('"') > -1){
        alert('Please remove any " from your comments before validating.')
        return false;
      }
      c = get_score();
      console.log(c)
      if (ans != '' && c === ''){
         alert('Please also give a score or remove your comment otherwise.')
         return false;
      }
      else{
        return true;
      }
    }

    function cycle_button(e){
      if ($(this).hasClass("btn-secondary")) {
          $(this).removeClass("btn-secondary");
          $(this).addClass("btn-success");
      }
      else if ($(this).hasClass("btn-success")) {
          $(this).removeClass("btn-success");
          $(this).addClass("btn-danger");
      }
      else if ($(this).hasClass("btn-danger")) {
          $(this).removeClass("btn-danger");
          $(this).addClass("btn-warning");
      }
      else if ($(this).hasClass("btn-warning")) {
          $(this).removeClass("btn-warning");
          $(this).addClass("btn-secondary");
      }
    }

    function color_button(value){
      $("#score").removeClass("btn-success");
      $("#score").removeClass("btn-danger");
      $("#score").removeClass("btn-secondary");
      $("#score").removeClass("btn-warning");
      if ("" + value == ""){
        $("#score").addClass("btn-secondary");
      }
      else{
        value = parseInt(value);
        if (value == 1){
          $("#score").addClass("btn-warning");
        }
        else if (value == 0){
          $("#score").addClass("btn-success");
        }
        else if (value == -1){
          $("#score").addClass("btn-danger");
        }
      }
    }
    function color_test(value){
      $("#test").removeClass("btn-success");
      $("#test").removeClass("btn-danger");
      $("#test").removeClass("btn-secondary");
      if (value == "True"){
        $("#test").addClass("btn-success");
      }
      else if (value == "False"){
        $("#test").addClass("btn-danger");
      }
    }

    function get_score(){
      if ($("#score").hasClass('btn-secondary')) {
          return '';
      }
      else if ($("#score").hasClass('btn-danger')) {
          return -1;
      }
      else if ($("#score").hasClass('btn-warning')) {
          return 1;
      }
      else if ($("#score").hasClass('btn-success')) {
          return 0;
      }

    }

    $("a").click(function(e){
      id = $(this).attr('id');
      e.preventDefault();

      if (id == 'xnat'){
         //src = $("img.subject" + visible_subject).attr('src')
         imgObj = images[visible_subject - 1];
         src = imgObj.small;
         $.ajax({
               type: "POST",
               url: "/xnat/",
               data: {"src": src},
               dataType:'json',
               success: function(data) {
                 url = 'https://barcelonabrainimaging.org/data/'
                    + 'experiments/' + data + '?format=html'
                 var win = window.open(url, '_blank');
                 if (win) {
                     win.focus();
                 } else {
                     alert('Please allow popups for this website');
                 }
                 return true;
               },
               error: function(xhr, status, error){
                 console.log(error)
                 console.log(xhr)
                 console.log(status)
               }
             });

      }
      else if (id == "prevsubj") {
        if (validate() == true){
          save_subject("prev");

          visible_class = 'subject' + visible_subject;
          if (visible_subject == 1) {
            visible_subject = n_subjects;
          }
          else {
            visible_subject = visible_subject - 1;
          }

          showImage() //visible_class, visible_subject, visible_image)
        }
      }
      else if (id == "nextsubj"){
        if (validate() == true){
          save_subject("next");

          visible_class = 'subject' + visible_subject;
          if (visible_subject == n_subjects) {
            visible_subject = 1;
          }
          else {
            visible_subject = visible_subject + 1;
          }

          showImage() ; //visible_class, visible_subject, visible_image)
        }
      }
      else if (id == 'nextbad'){
        if (validate() == true){
           save_subject("nextbad");
        }
      }
      return false;
    });

    $.urlParam = function(name){
        var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
        if (results==null){
           return null;
        }
        else{
           return results[1] || 0;
        }
    }

    function save_subject(then){
      s = $.urlParam('s')
      if (s==null){
        s = ''
      }

      $.ajax({
            type: "POST",
            url: "/post/",
            data: {"score": get_score(),
                   "comments": $('input').val(),
                   "subject":visible_subject,
                   "pipeline":s,
                   "then":then},
            dataType:'json',
            success: function(data) {
                if ($('#score').hasClass('btn-secondary')){
                    $( "span.skipped" ).fadeIn( 150 ).delay( 100 ).fadeOut( 300 );
                }
                else {
                  $( "span.success" ).fadeIn( 150 ).delay( 100 ).fadeOut( 300 );
                }
                color_button(data[0]);
                $('input').val(data[1]);
                $('#username').text(data[2]);
                if (then == 'nextbad'){
                  visible_class = 'subject' + visible_subject;
                  visible_subject = parseInt(data[3]);
                  showImage()
                }
                if (data.length > 4){
                  color_test(data[4]);
                  for (i = 0 ; i < data[5].length ; i++){
                    $('#test'+i).removeClass("badge-light")
                    $('#test'+i).removeClass("badge-success")
                    $('#test'+i).removeClass("badge-danger")
                    if (data[5][i][1] == 'True'){
                      $('#test'+i).text(data[5][i][0]) //+': ' + data[5][i][1])
                      $('#test'+i).addClass("badge-success")
                    }
                    else if (data[5][i][1] == 'False'){
                      $('#test'+i).text(data[5][i][0]) //+': ' + data[5][i][1])
                      $('#test'+i).addClass("badge-danger")
                    }
                    else {
                      s = data[5][i][1];
                      if (s.length >7) {
                        s = s.substring(0, 7) + "â€¦";
                      }

                      $('#test'+i).text(data[5][i][0]+': ' + s)
                      $('#test'+i).addClass("badge-light")
                      $('#test'+i).attr('title', data[5][i][1])
                      $('#test'+i).attr('data-original-title', data[5][i][1])
                    }
                    $('#test'+i).tooltip();
                    $('[data-toggle="tooltip"]').tooltip();

                  }
                }
                return data;

            }
        });
    }
    $('a#logout').unbind('click')
    $('a#download').unbind('click')
    $("#score").click(cycle_button);

    showImage();
    $('[data-toggle="tooltip"]').tooltip();


    </script>
  </body>
</html>
